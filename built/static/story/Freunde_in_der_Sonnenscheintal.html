<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Freunde_in_der_Sonnenscheintal</title>
    <link rel="stylesheet" type="text/css" href="/built/css/normalize.css">
    <link rel="stylesheet" type="text/css" href="/built/css/system.css">
    <link rel="stylesheet" type="text/css" href="/built/css/story.css">
</head>

<body>
    <h1>Freunde_in_der_Sonnenscheintal</h1>
    <label for="existingSpeakers">Select Existing Speaker:</label>
    <select id="existingSpeakers" name="existingSpeakers">
    </select>

    <br>

    <label for="allSpeakers">Select New Speaker:</label>
    <select id="allSpeakers" name="allSpeakers">
        <option value="">Select a new speaker</option>
    </select>

    <br>

    <button id="generateButton" disabled>Generate Audio for New Speaker</button>
    <div id="generationStatus"></div>

    <div id="audioChunks">
        <div class="chunk" data-index="1">
            <p>Freunde in der Sonnenscheintal

In einem grünen Tal lebten viele Freunde. Ein kleiner Bär, ein Fuchs, ein Hase und ein Vogel spielten miteinander. Sie tanzten, sangen und lachten.</p>
            <audio controls id="audio-1" data-index="1">
                <source src="/built/static/audio/standard_de_Freunde_in_der_Sonnenscheintal_1.wav"
                    type="audio/wav">
                Your browser does not support the audio element.
            </audio>
        </div>
        <div class="chunk" data-index="2">
            <p>Der Bär brachte Blumen für die Hase, der Fuchs zeigte dem Vogel den Weg zum besten Baum. Sie waren glücklich, weil sie sich liebten. Die Sonne ging unter, die Freunde gingen schlafen. Sie träumten von weiteren Abenteuern. The end.</p>
            <audio controls id="audio-2" data-index="2">
                <source src="/built/static/audio/standard_de_Freunde_in_der_Sonnenscheintal_2.wav"
                    type="audio/wav">
                Your browser does not support the audio element.
            </audio>
        </div>
    </div>

    <div id="speakerData" data-existing-speakers='[&quot;standard&quot;]' data-all-speakers='[&quot;standard&quot;, &quot;michel&quot;, &quot;recorded&quot;, &quot;michel_short&quot;]'>
    </div>

    <!-- JavaScript to handle audio generation -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const originalTitle = "Freunde_in_der_Sonnenscheintal";
            const sanitizedTitle = "Freunde_in_der_Sonnenscheintal";
            const existingSpeakersSelect = document.getElementById('existingSpeakers');
            const allSpeakersSelect = document.getElementById('allSpeakers');
            const generateButton = document.getElementById('generateButton');
            const generationStatus = document.getElementById('generationStatus');
            const language = "de";

            const speakerData = document.getElementById('speakerData');
            const existingSpeakersJson = speakerData.getAttribute('data-existing-speakers');
            const allSpeakersJson = speakerData.getAttribute('data-all-speakers');

            let existingSpeakers, allSpeakers;
            try {
                existingSpeakers = JSON.parse(existingSpeakersJson);
                allSpeakers = JSON.parse(allSpeakersJson);
            } catch (error) {
                console.error("Error parsing JSON:", error);
                existingSpeakers = [];
                allSpeakers = [];
            }

            function updateAudioSources(speaker, audioFiles = null) {
                const audioElements = document.querySelectorAll('audio');
                audioElements.forEach((audio, index) => {
                    const audioIndex = audio.dataset.index;
                    let newSrc;
                    if (audioFiles && audioFiles.length > index && audioFiles[index].audio) {
                        newSrc = audioFiles[index].audio;
                    } else {
                        newSrc =
                            `/built/static/audio/${speaker}_${language}_${sanitizedTitle}_${audioIndex}.wav`;
                    }
                    audio.querySelector('source').src = newSrc;
                    audio.load();
                });
            }

            function populateExistingSpeakers(speakers) {
                existingSpeakersSelect.innerHTML = '';
                speakers.forEach(speaker => {
                    const option = document.createElement('option');
                    option.value = speaker;
                    option.textContent = speaker;
                    existingSpeakersSelect.appendChild(option);
                });
            }

            function populateAllSpeakers(allSpeakers, existingSpeakers) {
                allSpeakersSelect.innerHTML = '<option value="">Select a new speaker</option>';
                allSpeakers.forEach(speaker => {
                    if (!existingSpeakers.includes(speaker)) {
                        const option = document.createElement('option');
                        option.value = speaker;
                        option.textContent = speaker;
                        allSpeakersSelect.appendChild(option);
                    }
                });
            }

            populateExistingSpeakers(existingSpeakers);
            populateAllSpeakers(allSpeakers, existingSpeakers);

            if (existingSpeakers.length > 0) {
                existingSpeakersSelect.value = existingSpeakers[0];
                updateAudioSources(existingSpeakers[0]);
            }

            existingSpeakersSelect.addEventListener('change', function () {
                updateAudioSources(this.value);
            });

            allSpeakersSelect.addEventListener('change', function () {
                generateButton.disabled = !this.value;
            });

            generateButton.addEventListener('click', function () {
                const speaker = allSpeakersSelect.value;
                if (!speaker) return;

                generationStatus.textContent = "Generating audio...";
                generateButton.disabled = true;

                // Collect all text from chunks
                const fullText = Array.from(document.querySelectorAll('.chunk p'))
                    .map(p => p.textContent)
                    .join(' ');

                fetch('http://localhost:5000/generate_audio', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            speaker: speaker,
                            language: language,
                            title: originalTitle,
                            text: fullText
                        }),
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            generationStatus.textContent = "Audio generated successfully!";
                            updateAudioSources(speaker, data.audio_files);

                            // Update the existing speakers list
                            if (!existingSpeakers.includes(speaker)) {
                                existingSpeakers.push(speaker);
                            }
                            populateExistingSpeakers(existingSpeakers);

                            // Update the new speakers list
                            allSpeakers = allSpeakers.filter(s => s !== speaker);
                            populateAllSpeakers(allSpeakers, existingSpeakers);

                            // Set the first select input to the new speaker
                            existingSpeakersSelect.value = speaker;
                        } else {
                            generationStatus.textContent = "Error generating audio: " + data
                            .message;
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        generationStatus.textContent =
                            "An error occurred while generating audio: " +
                            error.message;
                    })
                    .finally(() => {
                        generateButton.disabled = false;
                    });
            });

            const audioElements = document.querySelectorAll('audio');
            for (let i = 0; i < audioElements.length - 1; i++) {
                audioElements[i].addEventListener('ended', function () {
                    setTimeout(() => {
                        audioElements[i + 1].play();
                    }, 1000); // 1 second delay
                });
            }
        });
    </script>
</body>

</html>